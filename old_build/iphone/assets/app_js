var Alloy=require("alloy"),_=Alloy._,Backbone=Alloy.Backbone;maildebug=Titanium.App.Properties.getInt("maildebug")?Titanium.App.Properties.getInt("maildebug"):0,loc=Titanium.App.Properties.getString("loc")?Titanium.App.Properties.getString("loc"):"newberlin";var thefile=loc+".txt",file4=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,thefile),thefile5=loc+"1.txt",file5=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,thefile5);Alloy.Globals.writeFile=function(e,t){var i=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,t);i.write(e+"\n")},Alloy.Globals.appendFile=function(e,t){var i=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,t);i.append(e+"\n")};var debugfile="maildebug.txt",locfile="location.txt";Alloy.Globals.writeFile("Date,Timestamp,LAT,LON",locfile),"1"==Titanium.App.Properties.getInt("maildebug")&&(Alloy.Globals.writeFile(new Date+": debugging start",debugfile),Alloy.Globals.writeFile("Date,Timestamp,LAT,LON",locfile)),Alloy.Globals.getLocation=function(){var e='{"poi":[{"plaza":"0","latitude":"A1","longitude":"A1","altitude":"99.99","heading":"north","speed":"","hwy":"amazon.com"},{"name":"john","count":2},{"name":"joe","count":3}]}',t=JSON.parse(e),i=t.poi[0].plaza,a="http://54.197.150.195:10000/data";Ti.UI.createTableView();var o,l=Ti.Network.createHTTPClient({onload:function(t){try{o=JSON.parse(this.responseText);var i=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,"chicago.txt"),a=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,"json.txt");i.write(e),a.write(this.responseText),Ti.Api.info("check chicago: "+e);var l=o.poi[0].plaza;return Ti.Api.info("data1: "+l),l}catch(t){Ti.API.info("cathing e: "+t)}}});return l.onerror=function(e){alert(e)},l.open("GET",a),l.send(),i},Alloy.Globals.checkLoc=function(){Ti.Geolocation.locationServicesEnabled?(Titanium.Geolocation.purpose="Get Current Location",Titanium.Geolocation.getCurrentPosition(function(e){e.error?Ti.API.error("Error: "+e.error):(e.coords,mmsg=new Date(+e.coords.timestamp)+" : latitude :"+e.coords.latitude+" longitude : "+e.coords.longitude,1==Titanium.App.Properties.getInt("maildebug")&&Alloy.Globals.appendFile(mmsg,debugfile),console.log(mmsg))})):alert("Please enable location services")},Alloy.Globals.getGeneralLocation=function(e){var t="http://54.197.150.195:10000/"+e+".json",i=Ti.Network.createHTTPClient({onload:function(e){try{json=JSON.parse(this.responseText);var t=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,thefile);t.write(this.responseText)}catch(e){Ti.API.info("cathing e: "+e)}}});i.onerror=function(e){alert(e)},i.open("GET",t),i.send()&&alert(e+" POIs were successfuly downloaded from "+t+". Please proceed.")},Alloy.Globals.updateTollPlazaTable=function(e,t,i,a,o,l,n,r,s,d,c,p){var u=Alloy.createModel("tollplaza",{tollplaza:e,latitude:t,longitude:i,altitude:a,heading:o,speed:l,hwy:n,accuracy:"0",timestamp:"0",altitudeAccuracy:"0",cost:r,type:s,source:d,location:c,note:p});u.save()},Alloy.Globals.updateTollPlaza=function(e){Alloy.Collections.tollplaza.deleteLOC(e);var t="http://54.197.150.195:10000/"+e+".json",i=Ti.Network.createHTTPClient({onload:function(t){try{json=JSON.parse(this.responseText);for(var i=0;+json.poi.length>i;i++){var a=json.poi[i].plaza,o=json.poi[i].latitude,l=json.poi[i].longitude,n=json.poi[i].altitude||"none",r=json.poi[i].heading||"none",s=json.poi[i].speed||"none",d="interstate",c=json.poi[i].cost||"0",p=json.poi[i].type||"none",u="thetolleasy.com",g=e,m=i;Alloy.Globals.updateTollPlazaTable(a,o,l,n,r,s,d,c,p,u,g,m)}}catch(t){Ti.API.info("cathing e: "+t)}}});i.onerror=function(e){alert("error downloading data from primary site, "+t+" , downloading data using a backup site instead"),Alloy.Collections.tollplaza.deleteAll();var i="https://spreadsheets.google.com/feeds/list/1Omzwq1RKWeptvtV4H0ryLi3IP2fFdPFNqBPq2_nuuCc/od6/public/basic?hl=en_US&alt=json",a=Ti.Network.createHTTPClient({onload:function(e){try{T=JSON.parse(this.responseText);for(var t='{ "poi" : [\n',i=0;T.feed.entry.length>i;i++){var a=T.feed.entry[i].title.$t.trim(),o=T.feed.entry[i].content.$t.split(",")[0].split(":")[1].trim(),l=T.feed.entry[i].content.$t.split(",")[1].split(":")[1].trim(),n=T.feed.entry[i].content.$t.split(",")[2].split(":")[1].trim()||"none",r=T.feed.entry[i].content.$t.split(",")[3].split(":")[1].trim()||"none",s=T.feed.entry[i].content.$t.split(",")[4].split(":")[1].trim()||"none",d=T.feed.entry[i].content.$t.split(",")[5].split(":")[1].trim()||"interstate",c=T.feed.entry[i].content.$t.split(",")[6].split(":")[1].trim()||"0",p=T.feed.entry[i].content.$t.split(",")[7].split(":")[1].trim()||"none",u=T.feed.entry[i].content.$t.split(",")[8].split(":")[1].trim()||"unknown",g=T.feed.entry[i].content.$t.split(",")[9].split(":")[1].trim()||"unknown",m=i;Alloy.Globals.updateTollPlazaTable(a,o,l,n,r,s,d,c,p,u,g,m),t+=i==T.feed.entry.length-1?'{ "plaza" : "'+a+'" , "latitude" : "'+o+'" , "longitude" : "'+l+'"  , "altitude" : "'+n+'" , "heading" : "'+r+'" , "speed" : "'+s+'" , "hwy" : "'+d+'" , "cost" : "'+c+'" }]}\n':'{ "plaza" : "'+a+'" , "latitude" : "'+o+'" , "longitude" : "'+l+'"  , "altitude" : "'+n+'" , "heading" : "'+r+'" , "speed" : "'+s+'" , "hwy" : "'+d+'" , "cost" : "'+c+'" },\n'}file5.write(t),file4.write(t);var T=t}catch(e){Ti.API.info("cathing e: "+e)}}}),o=new Date+": load file error cathing e: "+JSON.stringify(e);1==Titanium.App.Properties.getInt("maildebug")&&Alloy.Globals.appendFile(o,debugfile),a.open("GET",i),a.send()},i.open("GET",t),i.send()},Alloy.Globals.calcDistance=function(e,t,i,a,o){var l=Math.PI*e/180,n=Math.PI*i/180,r=Math.PI*t/180,s=Math.PI*a/180,d=t-a,c=Math.PI*d/180,p=Math.sin(l)*Math.sin(n)+Math.cos(l)*Math.cos(n)*Math.cos(c);p=Math.acos(p),p=180*p/Math.PI,p=69.09*p,"K"==o&&(p=1.609344*p),"N"==o&&(p=.8684*p),"F"==o&&(p=5280*p);var u="dist:"+p+"lat1:"+e+",lat2:"+i+",radlat1:"+l+",radlat2:"+n+",lon1:"+t+",lon2:"+a+",radlon1:"+r+",radlon2:"+s+",radtheta:"+c+"\n",g=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,"calcfile.txt");return g.write(u),Math.round(p)},Alloy.Globals.updateFound=function(e,t,i,a,o,l,n){var r=heading=accuracy=altitudeAccuracy=data1=data2=speed="0",o=o||"0.00",s="Alloy.Globals.updateFound: "+new Date+": About to update found DB: tp : "+e+", lon:"+t+", lat : "+i+", cost : "+o+", type : "+l+", timestamp : "+a+"\n";1==Titanium.App.Properties.getInt("maildebug")&&Alloy.Globals.appendFile(s,debugfile),console.log(s);var d=Ti.Database.open("_alloy_");d.execute("BEGIN"),d.execute("INSERT INTO found (tollplaza,longitude,latitude,altitude,heading,accuracy,speed,timestamp,altitudeAccuracy,cost,type,hwy,data1,data2) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)",e,t,i,r,heading,accuracy,speed,a,altitudeAccuracy,o,l,n,data1,data2),d.execute("COMMIT"),d.close()},Alloy.Globals.distanceDetectTollPlaza=function(e){var t=closestdist=[];if(Ti.Geolocation.locationServicesEnabled)if(Titanium.Geolocation.purpose="Get Current Location",Titanium.Geolocation.trackSignificantLocationChange=!0,Titanium.Geolocation.getCurrentPosition(function(i){if(i.error)Ti.API.error("Error: "+i.error);else{var a=+i.coords.longitude,o=+i.coords.latitude,l=+i.coords.timestamp;Titanium.Geolocation.reverseGeocoder(o,a,function(e){if(e.success){var t=e.places;currentaddr=t&&t.length?t[0].address:"No address found",Titanium.App.Properties.setString("currentaddr",currentaddr),Ti.API.debug("reverse geolocation result = "+JSON.stringify(e))}else Ti.API.info("Code translation: "+JSON.stringify(i.code))});var n=Ti.Database.open("_alloy_"),r=n.execute('SELECT tollplaza,latitude,longitude,hwy,cost,type,note,location FROM tollplaza where location ="'+e+'"');try{for(;r.isValidRow();){var s=r.fieldByName("tollplaza"),d=r.fieldByName("latitude"),c=r.fieldByName("longitude"),p=Alloy.Globals.calcDistance(o,a,d,c,"F"),u="tolldata each: "+s+":"+d+":"+c+":"+p;t.push({tolltollplaza:s,dist:p,latitude:d,longitude:c,hwy:I,cost:z,type:S,note:N}),r.next()}}catch(g){alert(g)}n.close();var m=t.sort(function(e,t){return e.dist-t.dist});m[0].tolltollplaza;var T=m[0].tolltollplaza;m[0].dist,m[1].tolltollplaza,m[1].dist,m[2].tolltollplaza,m[2].dist;var y=m[0].tolltollplaza+" distance : "+m[0].dist;Titanium.App.Properties.setString("outputclosesttollbydist0",y);var f=158672e12,A=Titanium.App.Properties.getString("timelastupd")||0,h=Titanium.App.Properties.getString("tolllastupd")||"None",A=parseFloat(A),b=l-A,v=1e4;if(f>m[0].dist&&b>v&&T!=h){var G=m[0].tolltollplaza,P=m[0].longitude,w=m[0].latitude,F=l,z=m[0].cost,S=m[0].type,I=m[0].hwy,N=m[0].note;Alloy.Globals.updateFound(G,P,w,F,z,S,I),Titanium.App.Properties.setString("timelastupd",F),Titanium.App.Properties.setString("tolllastupd",G)}else if(1==Titanium.App.Properties.getInt("maildebug")){var C=new Date,u=C+": is this existing toll? "+T+" vs. tolllastupd: "+h;u+=" is range less than "+f+" ? : range is : "+m[0].dist,u+=" is timediff less than "+v+" ? : timediff is : "+b,console.log(u),Alloy.Globals.appendFile(u,debugfile)}}}),Titanium.Geolocation.hasCompass)Titanium.Geolocation.showCalibration=!1,Ti.Geolocation.getCurrentHeading(function(e){if(e.error)return currentHeading="error: "+e.error,void Ti.API.info("Code translation: "+translateErrorCode(e.code));var t=e.heading.x,i=e.heading.y,a=e.heading.z;e.heading.magneticHeading,e.heading.accuracy;var o=e.heading.trueHeading,l=e.heading.timestamp;currentHeading="x:"+t+" y: "+i+" z:"+a,Titanium.API.info("geo - current heading: "+new Date(l)+" x "+t+" y "+i+" z "+a),Titanium.App.Properties.setString("currentHeading",o)});else{Titanium.API.info("No Compass on device"),currentHeading="No compass available";var i="No compass available";Titanium.App.Properties.setString("currentHeading",i)}else alert("Please enable location services")},Alloy.Globals.eventDetectTollPlaza=function(e,t){var a=file4.read()||file5.read(),o=a.text,l=l||JSON.parse(o),n="json data : "+JSON.stringify(l);1==Titanium.App.Properties.getInt("maildebug")&&Alloy.Globals.appendFile(n,debugfile),lat1=time1=timelastdebug=0;var r=function(e){var t=+e.coords.longitude,a=+e.coords.latitude,o=+e.coords.timestamp;if(1==Titanium.App.Properties.getInt("maildebug")&&o-r>=6e4){var n="lon : lat : time :"+t+":"+a+":"+new Date(o);Alloy.Globals.appendFile(n,debugfile);var r=o}for(Titanium.Geolocation.reverseGeocoder(a,t,function(e){if(e.success){var t=e.places;currentaddr=t&&t.length?t[0].address:"No address found",Titanium.App.Properties.setString("currentaddr",currentaddr),Ti.API.debug("reverse geolocation result = "+JSON.stringify(e))}}),i=0;l.poi.length>i;i++){var s=l.poi[i].plaza,c=l.poi[i].latitude,p=l.poi[i].longitude,u=Alloy.Globals.calcDistance(a,t,c,p,"F");d.push({tolltollplaza:s,dist:u,latitude:c,longitude:p,hwy:S,cost:F,type:z,note:I})}var g=d.sort(function(e,t){return e.dist-t.dist});g[0].tolltollplaza;var m=g[0].tolltollplaza;g[0].dist,g[1].tolltollplaza,g[1].dist,g[2].tolltollplaza,g[2].dist;var T=g[0].tolltollplaza+" distance : "+g[0].dist;Titanium.App.Properties.setString("outputclosesttollbydist0",T);var y=100,f=Titanium.App.Properties.getString("timelastupd")||0,A=Titanium.App.Properties.getString("tolllastupd")||"None",f=parseFloat(f),h=o-f,b=1e4;if(y>g[0].dist&&h>b&&m!=A){var v=g[0].tolltollplaza,G=g[0].longitude,P=g[0].latitude,w=o,F=g[0].cost,z=g[0].type,S=g[0].hwy,I=g[0].note;Alloy.Globals.updateFound(v,G,P,w,F,z,S),Titanium.App.Properties.setString("timelastupd",w),Titanium.App.Properties.setString("tolllastupd",v),Ti.App.iOS.scheduleLocalNotification({alertBody:new Date+" : tollplaza "+v+" was detected less than "+g[0].dist+" ft away",date:new Date((new Date).getTime()+1e3)});var n=new Date+" : tollplaza "+v+" was detected less than "+g[0].dist+" ft away";1==Titanium.App.Properties.getInt("maildebug")&&Alloy.Globals.appendFile(n,debugfile)}else if(1==Titanium.App.Properties.getInt("maildebug")){var N=new Date,n=N+": is this existing toll? "+m+" vs. tolllastupd: "+A;n+=" is range less than "+y+" ? : range is : "+g[0].dist,n+=" is timediff less than "+b+" ? : timediff is : "+h,console.log(n),Alloy.Globals.appendFile(n,debugfile)}},s=function(e){if(e.error)return void(updatedHeading="error: "+e.error);var t=e.heading.x,i=e.heading.y,a=e.heading.z;e.heading.magneticHeading,e.heading.accuracy;var o=e.heading.trueHeading,l=e.heading.timestamp;currentHeading="x:"+t+" y: "+i+" z:"+a,Titanium.API.info("geo - current heading: "+new Date(l)+" x "+t+" y "+i+" z "+a),Titanium.App.Properties.setString("currentHeading",o)};if(Ti.Geolocation.locationServicesEnabled){var d=closestdist=[];if(Titanium.Geolocation.accuracy=Titanium.Geolocation.ACCURACY_BEST,Titanium.Geolocation.distanceFilter=5,Titanium.Geolocation.purpose="Get Current Location",Titanium.Geolocation.addEventListener("location",r),locationAdded=!0&&Titanium.App.Properties.setString("locationAdded","true"),Titanium.Geolocation.hasCompass)Titanium.Geolocation.showCalibration=!1,Titanium.Geolocation.headingFilter=5,Titanium.Geolocation.addEventListener("heading",s),headingAdded=!0;else{Titanium.API.info("No Compass on device"),currentHeading="No compass available";var c="No compass available";Titanium.App.Properties.setString("currentHeading",c)}}else alert("Please enable location services");"remove"==t&&(Ti.API.info("removing location callback on "+t),Titanium.Geolocation.distanceFilter=1e6,Titanium.Geolocation.addEventListener("location",r),locationAdded=!1,Titanium.Geolocation.headingFilter=359,Titanium.Geolocation.addEventListener("heading",s),headingAdded=!1)},Alloy.Globals.eventSimpleLocDet=function(){var e=function(e){var t=+e.coords.longitude,i=+e.coords.latitude,a=+e.coords.timestamp,o=new Date(a)+","+a+","+i+","+t;if(console.log(o),1==Titanium.App.Properties.getInt("maildebug")&&a-l>=3e4){Alloy.Globals.appendFile(o,debugfile);var l=a}Alloy.Globals.appendFile(o,debugfile)};Ti.Geolocation.locationServicesEnabled?(Titanium.Geolocation.accuracy=Titanium.Geolocation.ACCURACY_BEST,Titanium.Geolocation.distanceFilter=1,Titanium.Geolocation.purpose="Get Current Location",Titanium.Geolocation.addEventListener("location",e),locationAdded=!0):alert("Please enable location services")},Alloy.Globals.createAnnotations=function(){for(var e=[],t=0;10>t;t++){var i=Titanium.Map.createAnnotation({latitude:37.390749,longitude:-122.081651,title:"Appcelerator Headquarters",subtitle:"Mountain View, CA",pincolor:isAndroid?"orange":Titanium.Map.ANNOTATION_RED,animate:!0,myid:t});e.push(i)}return e},Alloy.createController("index");