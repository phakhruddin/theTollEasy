maildebug=Titanium.App.Properties.getInt("maildebug")?Titanium.App.Properties.getInt("maildebug"):0,loc=Titanium.App.Properties.getString("loc")?Titanium.App.Properties.getString("loc"):"newberlin";var initialNotif=Ti.App.iOS.scheduleLocalNotification({alertBody:"is detecting the tollplaza in the background starting ,"+new Date+".",date:new Date((new Date).getTime()+1e3)}),writeFile=function(e,t){var i=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,t);i.write(e+"\n")},appendFile=function(e,t){var i=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,t);i.append(e+"\n")},debugfile="maildebug.txt";"1"==maildebug&&writeFile(new Date+": debugging start",debugfile);var thefile=loc+".txt",file4=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,thefile),thefile5=loc+"1.txt",file5=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,thefile5),downloadTollplaza=function(e){var t="http://54.197.150.195:10000/"+e+".json",i=Ti.Network.createHTTPClient({onload:function(e){try{json=JSON.parse(this.responseText),file4.write(this.responseText)}catch(e){Ti.API.info("cathing e: "+e)}}});i.onerror=function(e){Ti.App.iOS.scheduleLocalNotification({alertBody:"error downloading data from primary site, "+t+" , downloading data using a backup site instead",date:new Date((new Date).getTime()+1e3)});var i="https://spreadsheets.google.com/feeds/list/1Omzwq1RKWeptvtV4H0ryLi3IP2fFdPFNqBPq2_nuuCc/od6/public/basic?hl=en_US&alt=json",a=Ti.Network.createHTTPClient({onload:function(e){try{u=JSON.parse(this.responseText);for(var t='{ "poi" : [\n',i=0;u.feed.entry.length>i;i++){var a=u.feed.entry[i].title.$t.trim(),l=u.feed.entry[i].content.$t.split(",")[0].split(":")[1].trim(),o=u.feed.entry[i].content.$t.split(",")[1].split(":")[1].trim(),n=u.feed.entry[i].content.$t.split(",")[2].split(":")[1].trim()||"none",r=u.feed.entry[i].content.$t.split(",")[3].split(":")[1].trim()||"none",s=u.feed.entry[i].content.$t.split(",")[4].split(":")[1].trim()||"none",d=u.feed.entry[i].content.$t.split(",")[5].split(":")[1].trim()||"interstate",c=u.feed.entry[i].content.$t.split(",")[6].split(":")[1].trim()||"0";u.feed.entry[i].content.$t.split(",")[7].split(":")[1].trim()||"none",u.feed.entry[i].content.$t.split(",")[8].split(":")[1].trim()||"unknown",u.feed.entry[i].content.$t.split(",")[9].split(":")[1].trim()||"unknown",t+=i==u.feed.entry.length-1?'{ "plaza" : "'+a+'" , "latitude" : "'+l+'" , "longitude" : "'+o+'"  , "altitude" : "'+n+'" , "heading" : "'+r+'" , "speed" : "'+s+'" , "hwy" : "'+d+'" , "cost" : "'+c+'" }]}\n':'{ "plaza" : "'+a+'" , "latitude" : "'+l+'" , "longitude" : "'+o+'"  , "altitude" : "'+n+'" , "heading" : "'+r+'" , "speed" : "'+s+'" , "hwy" : "'+d+'" , "cost" : "'+c+'" },\n'}file5.write(t),file4.write(t);var u=t}catch(e){Ti.API.info("cathing e: "+e)}}}),l=new Date+": load file error cathing e: "+JSON.stringify(e);1==maildebug&&appendFile(l,debugfile),a.open("GET",i),a.send()},i.open("GET",t),i.send()};downloadTollplaza(loc);var checkAlive=setInterval(function(){var e=new Date+" keep Alive check";console.log(e),1==maildebug&&appendFile(e,debugfile),Ti.App.iOS.scheduleLocalNotification({alertBody:new Date+" checkAlive.",date:new Date((new Date).getTime()+3e3)})},3e5),calcDistance=function(e,t,i,a,l){var o=Math.PI*e/180,n=Math.PI*i/180,r=Math.PI*t/180,s=Math.PI*a/180,d=t-a,c=Math.PI*d/180,u=Math.sin(o)*Math.sin(n)+Math.cos(o)*Math.cos(n)*Math.cos(c);u=Math.acos(u),u=180*u/Math.PI,u=69.09*u,"K"==l&&(u=1.609344*u),"N"==l&&(u=.8684*u),"F"==l&&(u=5280*u);var p=new Date+": dist:"+u+"lat1:"+e+",lat2:"+i+",radlat1:"+o+",radlat2:"+n+",lon1:"+t+",lon2:"+a+",radlon1:"+r+",radlon2:"+s+",radtheta:"+c+"\n",_=Ti.Filesystem.getFile(Ti.Filesystem.tempDirectory,"calcfile.txt");return _.write(p),Math.round(u)},updateFound=function(e,t,i,a,l,o,n){var r=heading=accuracy=altitudeAccuracy=data1=data2=speed="0",l=l||"0.00",s="updateFound: "+new Date+": About to update found DB: tp : "+e+", lon:"+t+", lat : "+i+", cost : "+l+", type : "+o+", timestamp : "+a+"\n";1==maildebug&&appendFile(s,debugfile),console.log(s);var d=Ti.Database.open("_alloy_");d.execute("BEGIN"),d.execute("INSERT INTO found (tollplaza,longitude,latitude,altitude,heading,accuracy,speed,timestamp,altitudeAccuracy,cost,type,hwy,data1,data2) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)",e,t,i,r,heading,accuracy,speed,a,altitudeAccuracy,l,o,n,data1,data2),d.execute("COMMIT"),d.close()},bgLocFound=function(){var e="",e=file4.read()||file5.read();if(e.text)var t=e.text,a=a||JSON.parse(t);var l="json data : "+JSON.stringify(a);1==maildebug&&appendFile(l,debugfile);var o=function(e){var t=+e.coords.longitude,l=+e.coords.latitude,o=+e.coords.timestamp;for(Titanium.Geolocation.reverseGeocoder(l,t,function(e){if(e.success){var t=e.places;currentaddr=t&&t.length?t[0].address:"No address found",Titanium.App.Properties.setString("currentaddr",currentaddr),Ti.API.debug("reverse geolocation result = "+JSON.stringify(e))}}),i=0;a.poi.length>i;i++){var n=a.poi[i].plaza,s=a.poi[i].latitude,d=a.poi[i].longitude,c=calcDistance(l,t,s,d,"F");r.push({tolltollplaza:n,dist:c,latitude:s,longitude:d,hwy:S,cost:I,type:A,note:E})}var u=r.sort(function(e,t){return e.dist-t.dist});u[0].tolltollplaza;var p=u[0].tolltollplaza;u[0].dist,u[1].tolltollplaza,u[1].dist,u[2].tolltollplaza,u[2].dist;var _=u[0].tolltollplaza+"(BG) distance : "+u[0].dist;Titanium.App.Properties.setString("outputclosesttollbydist0",_);var m=100,T=Titanium.App.Properties.getString("timelastupd")||0,w=Titanium.App.Properties.getString("tolllastupd")||"None",T=parseFloat(T),g=o-T,f=1e4;if(m>u[0].dist&&g>f&&p!=w){var h=u[0].tolltollplaza,y=u[0].longitude,b=u[0].latitude,v=o,I=u[0].cost,A=u[0].type,S=u[0].hwy,E=u[0].note;updateFound(h,y,b,v,I,A,S),Titanium.App.Properties.setString("timelastupd",v),Titanium.App.Properties.setString("tolllastupd",h),Ti.App.iOS.scheduleLocalNotification({alertBody:new Date+" : tollplaza "+h+" was detected less than "+u[0].dist+" ft away",date:new Date((new Date).getTime()+1e3)});var U=new Date+" : tollplaza "+h+" was detected less than "+u[0].dist+" ft away";1==maildebug&&appendFile(U,debugfile)}else if(1==maildebug){var N=new Date,U=N+": is this existing toll? "+p+" vs. tolllastupd: "+w;U+=" is range less than "+m+" ? : range is : "+u[0].dist,U+=" is timediff less than "+f+" ? : timediff is : "+g,console.log(U),appendFile(U,debugfile)}},n=function(e){if(e.error)return void(updatedHeading="error: "+e.error);var t=e.heading.x,i=e.heading.y,a=e.heading.z;e.heading.magneticHeading,e.heading.accuracy;var l=e.heading.trueHeading,o=e.heading.timestamp;currentHeading="x:"+t+" y: "+i+" z:"+a,Titanium.API.info("geo - current heading: "+new Date(o)+" x "+t+" y "+i+" z "+a),Titanium.App.Properties.setString("currentHeading",l)};if(Ti.Geolocation.locationServicesEnabled){var r=closestdist=[];if(Titanium.Geolocation.accuracy=Titanium.Geolocation.ACCURACY_BEST,Titanium.Geolocation.distanceFilter=1,Titanium.Geolocation.purpose="Get Current Location",Titanium.Geolocation.getCurrentPosition(function(e){if(e.error)Ti.API.error("Error: "+e.error);else{var t=+e.coords.longitude,l=+e.coords.latitude,o=+e.coords.timestamp;for(Titanium.Geolocation.reverseGeocoder(l,t,function(e){if(e.success){var t=e.places;currentaddr=t&&t.length?t[0].address:"No address found",Titanium.App.Properties.setString("currentaddr",currentaddr),Ti.API.debug("reverse geolocation result = "+JSON.stringify(e))}}),i=0;a.poi.length>i;i++){var n=a.poi[i].plaza,s=a.poi[i].latitude,d=a.poi[i].longitude,c=calcDistance(l,t,s,d,"F");r.push({tolltollplaza:n,dist:c,latitude:s,longitude:d,hwy:U,cost:S,type:E,note:N})}var u=r.sort(function(e,t){return e.dist-t.dist});u[0].tolltollplaza;var p=u[0].tolltollplaza;u[0].dist,u[1].tolltollplaza,u[1].dist,u[2].tolltollplaza,u[2].dist;var _=u[0].tolltollplaza+" distance : "+u[0].dist,m=u[1].tolltollplaza+" distance : "+u[1].dist,T=u[2].tolltollplaza+" distance : "+u[2].dist;Titanium.App.Properties.setString("outputclosesttollbydist0",_),Titanium.App.Properties.setString("outputclosesttollbydist1",m),Titanium.App.Properties.setString("outputclosesttollbydist2",T);var w=100,g=Titanium.App.Properties.getString("timelastupd")||0,f=Titanium.App.Properties.getString("tolllastupd")||"None",g=parseFloat(g),h=o-g,y=1e4;if(w>u[0].dist&&h>y&&p!=f){var b=u[0].tolltollplaza,v=u[0].longitude,I=u[0].latitude,A=o,S=u[0].cost,E=u[0].type,U=u[0].hwy,N=u[0].note;updateFound(b,v,I,A,S,E,U),Titanium.App.Properties.setString("timelastupd",A),Titanium.App.Properties.setString("tolllastupd",b),Ti.App.iOS.scheduleLocalNotification({alertBody:new Date+" : tollplaza "+b+" was detected less than "+u[0].dist+" ft away",date:new Date((new Date).getTime()+5e3)});var x=new Date+" : tollplaza "+b+" was detected less than "+u[0].dist+" ft away";1==maildebug&&appendFile(x,debugfile)}else if(1==maildebug){var L=new Date,x=L+": is this existing toll? "+p+" vs. tolllastupd: "+f;x+=" is range less than "+w+" ? : range is : "+u[0].dist,x+=" is timediff less than "+y+" ? : timediff is : "+h,console.log(x),appendFile(x,debugfile)}}}),Titanium.Geolocation.addEventListener("location",o),locationAdded=!0,Titanium.Geolocation.hasCompass)Titanium.Geolocation.showCalibration=!1,Titanium.Geolocation.headingFilter=45,Ti.Geolocation.getCurrentHeading(function(e){if(e.error)return void(currentHeading="error: "+e.error);var t=e.heading.x,i=e.heading.y,a=e.heading.z;e.heading.magneticHeading,e.heading.accuracy;var l=e.heading.trueHeading,o=e.heading.timestamp;currentHeading="x:"+t+" y: "+i+" z:"+a,Titanium.API.info("geo - current heading: "+new Date(o)+" x "+t+" y "+i+" z "+a),Titanium.App.Properties.setString("currentHeading",l)}),Titanium.Geolocation.addEventListener("heading",n),headingAdded=!0;else{Titanium.API.info("No Compass on device"),currentHeading="No compass available";var s="No compass available";Titanium.App.Properties.setString("currentHeading",s)}}else Ti.App.iOS.scheduleLocalNotification({alertBody:"Please enable location services :"+new Date+".",date:new Date((new Date).getTime()+1e3)})};bgLocFound(loc),checkAlive=1;